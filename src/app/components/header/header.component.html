<header class="header-bg sticky top-0 z-50 theme-transition" (mouseleave)="hideMenu()">
  <nav class="max-w-screen-2xl mx-auto px-4 flex items-center justify-between h-12">
    <!-- Logo -->
    <a href="#" class="flex items-center hover:opacity-80 transition-opacity">
      <img 
        [src]="logoUrl()" 
        alt="Logo" 
        class="h-10 w-auto object-contain"
        onerror="this.style.display='none'">
    </a>

    <!-- Nav Items -->
    <ul class="flex items-center gap-8 text-xs">
      @for (item of navItems(); track item.name) {
        <li class="relative" (mouseenter)="showMenu(item)">
          <a href="#" class="nav-link">{{ item.name }}</a>
        </li>
      }
    </ul>

    <!-- Right Actions -->
    <div class="flex items-center gap-4">
      <button #searchIcon (click)="toggleSearch()" class="nav-link">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
        </svg>
      </button>

      <!-- Theme Toggle - positioned next to language selector (Requirement 6.1) -->
      <app-theme-toggle></app-theme-toggle>

      <!-- Language Selector -->
      <div #langDropdownContainer class="relative">
        <button 
          (click)="toggleLangDropdown()" 
          class="flex items-center gap-1 nav-link text-xs">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5h12M9 3v2m1.048 9.5A18.022 18.022 0 016.412 9m6.088 9h7M11 21l5-10 5 10M12.751 5C11.783 10.77 8.07 15.61 3 18.129"></path>
          </svg>
          <span>{{ selectedLanguage().code.toUpperCase() }}</span>
          <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
          </svg>
        </button>

        @if (isLangDropdownOpen()) {
          <div class="dropdown-menu animate-dropdown">
            @for (lang of languages(); track lang.code) {
              <button
                (click)="selectLanguage(lang)"
                class="dropdown-item"
                [class.dropdown-item-active]="selectedLanguage().code === lang.code">
                <span>{{ lang.name }}</span>
                @if (selectedLanguage().code === lang.code) {
                  <svg class="w-4 h-4 text-[var(--color-info)]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                  </svg>
                }
              </button>
            }
          </div>
        }
      </div>

      <a routerLink="/order" class="nav-link">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"></path>
        </svg>
      </a>

      <!-- User Profile / Sign In -->
      @if (user()) {
        <div #userDropdownContainer class="relative">
          <button (click)="toggleUserDropdown()" class="flex items-center gap-2 hover:opacity-80 transition-opacity">
            <img [src]="user()?.avatarUrl" alt="Avatar" class="w-8 h-8 rounded-full border border-gray-200 dark:border-gray-700 object-cover">
          </button>

          @if (isUserDropdownOpen()) {
            <div class="dropdown-menu animate-dropdown right-0 w-48">
              <div class="px-4 py-3 border-b border-gray-100 dark:border-gray-700">
                <p class="text-sm font-medium text-gray-900 dark:text-gray-100">{{ user()?.lastName }} {{ user()?.firstName }}</p>
                <p class="text-xs text-gray-500 dark:text-gray-400 truncate">{{ user()?.email }}</p>
              </div>
              <ul class="py-1">
                <li>
                  <a routerLink="/profile" (click)="isUserDropdownOpen.set(false)" class="dropdown-item flex items-center gap-2">
                    <span class="material-symbols-outlined text-lg">person</span>
                    Profile
                  </a>
                </li>
                <li>
                  <a routerLink="/my-store" (click)="isUserDropdownOpen.set(false)" class="dropdown-item flex items-center gap-2">
                    <span class="material-symbols-outlined text-lg">storefront</span>
                    My Store
                  </a>
                </li>
                <li>
                  <button (click)="logout()" class="dropdown-item flex items-center gap-2 w-full text-left text-red-600 hover:text-red-700 dark:text-red-400 dark:hover:text-red-300">
                    <span class="material-symbols-outlined text-lg">logout</span>
                    Sign out
                  </button>
                </li>
              </ul>
            </div>
          }
        </div>
      } @else {
        <a href="#" class="bg-gradient-to-r from-blue-500 to-purple-500 text-white px-4 py-1.5 rounded-full text-xs font-medium hover:from-blue-600 hover:to-purple-600 transition-all shadow-sm">
          Hi there! Sign in
        </a>
      }
    </div>
  </nav>

  <!-- Dropdown Menu -->
  @if (activeMenu(); as menuData) {
    <div
      (mouseenter)="onMenuEnter()"
      (mouseleave)="hideMenu()"
      class="absolute top-full left-0 right-0 mega-menu-bg shadow-xl opacity-0 animate-dropdown z-40 theme-transition"
      [class.opacity-100]="activeMenu()"
      style="animation: dropdownFade 0.3s cubic-bezier(0.4, 0, 0.2, 1) forwards;">
      <div class="max-w-screen-2xl mx-auto px-4 py-8">
        @if(menuData.menu; as menuColumns) {
          <div class="grid grid-flow-col auto-cols-max gap-x-16 ml-20">
            @for(column of menuColumns; track column.title; let i = $index) {
              <div class="animate-slideDown" [style.animation-delay]="i * 80 + 'ms'">
                <h3 class="menu-column-title">{{ column.title }}</h3>
                <ul class="space-y-2">
                  @for(link of column.links; track link) {
                    <li><a href="#" class="menu-link">{{ link }}</a></li>
                  }
                </ul>
              </div>
            }
          </div>
        }
      </div>
    </div>
  }

  <!-- Search Dropdown -->
  @if (isSearchOpen()) {
    <div
      #searchContainer
      class="absolute top-full left-0 right-0 mega-menu-bg shadow-xl opacity-0 animate-dropdown z-40 theme-transition"
      [class.opacity-100]="isSearchOpen()"
      style="animation: dropdownFade 0.3s cubic-bezier(0.4, 0, 0.2, 1) forwards;">
      <div class="max-w-screen-2xl mx-auto px-4 py-8">
        <div class="max-w-2xl mx-auto">
          <!-- Search Input with Gradient Border -->
          <div class="p-[2px] rounded-full bg-gradient-to-r from-blue-400 via-purple-400 to-pink-400 shadow-lg">
            <input 
              type="text" 
              placeholder="Search for products..." 
              class="search-input"
              autofocus>
          </div>
          
          <!-- Search Suggestions -->
          <div class="mt-6">
            <h3 class="menu-column-title">Popular Searches</h3>
            <ul class="grid grid-cols-2 gap-2">
              @for(link of quickLinks(); track link) {
                <li>
                  <a href="#" class="menu-link flex items-center gap-2">
                    <svg class="w-4 h-4 search-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                    </svg>
                    {{ link }}
                  </a>
                </li>
              }
            </ul>
          </div>
        </div>
      </div>
    </div>
  }

  <!-- Backdrop -->
  @if (activeMenu() || isSearchOpen() || isLangDropdownOpen() || isUserDropdownOpen()) {
    <div 
      (click)="closeAll()"
      class="fixed inset-0 top-12 backdrop-overlay transition-all duration-300 z-30 cursor-pointer"></div>
  }
</header>
